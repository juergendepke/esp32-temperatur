#include <BLEDevice.h>
#include <BLEUtils.h>
#include <BLEServer.h>
#include <BLE2902.h>

// Service und Characteristic UUIDs
#define SERVICE_UUID           "12345678-1234-5678-1234-56789abcdef0"
#define CHAR_TEMP_UUID         "12345678-1234-5678-1234-56789abcdef1"
#define CHAR_INTERVAL_UUID     "12345678-1234-5678-1234-56789abcdef2"
#define CHAR_LED_STATUS_UUID   "12345678-1234-5678-1234-56789abcdef3"
#define CHAR_DEVICE_TYPE_UUID  "12345678-1234-5678-1234-56789abcdef4"
#define CHAR_DEVICE_ID_UUID    "12345678-1234-5678-1234-56789abcdef5"
#define CHAR_VOLTAGE_UUID      "12345678-1234-5678-1234-56789abcdef6"

// GerÃ¤tetypen
#define DEVICE_TYPE_TEMPERATURE 0
#define DEVICE_TYPE_VOLTAGE     1
#define DEVICE_TYPE_MULTI       2

BLECharacteristic *tempCharacteristic;
BLECharacteristic *voltageCharacteristic;
BLECharacteristic *intervalCharacteristic;
BLECharacteristic *ledCharacteristic;
BLECharacteristic *deviceTypeCharacteristic;
BLECharacteristic *deviceIdCharacteristic;

bool deviceConnected = false;
bool oldDeviceConnected = false;
int intervalSeconds = 2;
bool ledOn = true;
float temperature = 23.5;
float voltage = 3.3;
String deviceId;

BLEServer *pServer;

// Sensor Simulationen
float readTemperature() {
    temperature += (random(-30, 31) * 0.01);
    temperature = constrain(temperature, 15.0, 35.0);
    return temperature;
}

float readVoltage() {
    voltage += (random(-10, 11) * 0.01);
    voltage = constrain(voltage, 2.5, 5.0);
    return voltage;
}

class ServerCallbacks: public BLEServerCallbacks {
    void onConnect(BLEServer* pServer) {
        deviceConnected = true;
        Serial.println("âœ… GerÃ¤t verbunden - Multi-Sensor");
        digitalWrite(LED_BUILTIN, HIGH);
    }

    void onDisconnect(BLEServer* pServer) {
        deviceConnected = false;
        Serial.println("âŒ GerÃ¤t getrennt");
        digitalWrite(LED_BUILTIN, LOW);
    }
};

class IntervalCallback: public BLECharacteristicCallbacks {
    void onWrite(BLECharacteristic *pCharacteristic) {
        String value = pCharacteristic->getValue().c_str();
        if (value.length() > 0) {
            intervalSeconds = value.toInt();
            Serial.println("ðŸ“Š Update-Intervall geÃ¤ndert: " + String(intervalSeconds) + "s");
        }
    }
};

class LedCallback: public BLECharacteristicCallbacks {
    void onWrite(BLECharacteristic *pCharacteristic) {
        String value = pCharacteristic->getValue().c_str();
        if (value.length() > 0) {
            ledOn = (value == "1");
            digitalWrite(LED_BUILTIN, ledOn ? HIGH : LOW);
            Serial.println("ðŸ’¡ LED Status: " + String(ledOn ? "EIN" : "AUS"));
        }
    }
};

void setup() {
    Serial.begin(115200);
    
    // Eindeutige Device ID erstellen
    deviceId = "Multi-" + String((uint32_t)ESP.getEfuseMac(), HEX);
    
    // LED Pin
    pinMode(LED_BUILTIN, OUTPUT);
    digitalWrite(LED_BUILTIN, HIGH);
    
    Serial.println("ðŸ”€ Starte BLE Multi-Sensor...");
    Serial.println("Device ID: " + deviceId);

    BLEDevice::init(deviceId.c_str());

    pServer = BLEDevice::createServer();
    pServer->setCallbacks(new ServerCallbacks());

    BLEService *pService = pServer->createService(SERVICE_UUID);

    // Characteristics erstellen
    tempCharacteristic = pService->createCharacteristic(
        CHAR_TEMP_UUID,
        BLECharacteristic::PROPERTY_READ |
        BLECharacteristic::PROPERTY_NOTIFY
    );
    tempCharacteristic->addDescriptor(new BLE2902());

    voltageCharacteristic = pService->createCharacteristic(
        CHAR_VOLTAGE_UUID,
        BLECharacteristic::PROPERTY_READ |
        BLECharacteristic::PROPERTY_NOTIFY
    );
    voltageCharacteristic->addDescriptor(new BLE2902());

    intervalCharacteristic = pService->createCharacteristic(
        CHAR_INTERVAL_UUID,
        BLECharacteristic::PROPERTY_READ |
        BLECharacteristic::PROPERTY_WRITE
    );
    intervalCharacteristic->setCallbacks(new IntervalCallback());

    ledCharacteristic = pService->createCharacteristic(
        CHAR_LED_STATUS_UUID,
        BLECharacteristic::PROPERTY_READ |
        BLECharacteristic::PROPERTY_WRITE
    );
    ledCharacteristic->setCallbacks(new LedCallback());

    deviceTypeCharacteristic = pService->createCharacteristic(
        CHAR_DEVICE_TYPE_UUID,
        BLECharacteristic::PROPERTY_READ
    );

    deviceIdCharacteristic = pService->createCharacteristic(
        CHAR_DEVICE_ID_UUID,
        BLECharacteristic::PROPERTY_READ
    );

    // Startwerte setzen
    intervalCharacteristic->setValue(String(intervalSeconds).c_str());
    ledCharacteristic->setValue(ledOn ? "1" : "0");
    deviceTypeCharacteristic->setValue(String(DEVICE_TYPE_MULTI).c_str());
    deviceIdCharacteristic->setValue(deviceId.c_str());

    pService->start();
    
    // Advertising
    BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();
    pAdvertising->addServiceUUID(SERVICE_UUID);
    pAdvertising->setScanResponse(true);
    pAdvertising->setMinPreferred(0x06);
    pAdvertising->setMinPreferred(0x12);
    
    pServer->getAdvertising()->start();
    
    Serial.println("âœ… BLE Multi-Sensor bereit - Warte auf Verbindung...");
    Serial.println("ðŸ“± Jetzt mit der Web-App verbinden!");
}

unsigned long lastUpdate = 0;

void loop() {
    // Verbindungsmanagement
    if (!deviceConnected && oldDeviceConnected) {
        delay(500);
        pServer->startAdvertising();
        Serial.println("ðŸ”„ Starte Advertising...");
        oldDeviceConnected = deviceConnected;
    }
    
    if (deviceConnected && !oldDeviceConnected) {
        oldDeviceConnected = deviceConnected;
    }
    
    // Daten senden
    if (deviceConnected && millis() - lastUpdate > intervalSeconds * 1000) {
        lastUpdate = millis();
        
        // Sensoren lesen
        float currentTemp = readTemperature();
        float currentVoltage = readVoltage();
        
        String tempString = String(currentTemp, 1);
        String voltageString = String(currentVoltage, 2);
        
        // Daten senden
        tempCharacteristic->setValue(tempString.c_str());
        tempCharacteristic->notify();
        
        voltageCharacteristic->setValue(voltageString.c_str());
        voltageCharacteristic->notify();
        
        Serial.println("ðŸ“¤ Multi-Sensor Daten: " + tempString + " Â°C, " + voltageString + " V");
    }
    
    delay(100);
}
