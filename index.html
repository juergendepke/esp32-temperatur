<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.json" />
  <title>üçû Smart Bread Baker</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Segoe UI", Roboto, sans-serif;
      background: #f8f9fb;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 1rem;
    }
    .card {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      max-width: 420px;
      width: 100%;
    }
    input, button {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.4rem;
      border-radius: 0.8rem;
      border: 1px solid #ddd;
      font-size: 1rem;
    }
    button {
      background: black;
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: #333; }
    h1 { text-align: center; font-weight: 600; }
    canvas { width: 100%; height: 250px; margin-top: 1rem; }
    .tip { text-align: center; font-style: italic; color: #666; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üçû Smart Bread Baker</h1>
    <div id="form">
      <label>Rezeptname</label>
      <input id="rname" placeholder="z. B. Bauernbrot" />
      <label>Mehlart</label>
      <input id="mehl" placeholder="Weizen, Roggen ‚Ä¶" />
      <label>Hydration (%)</label>
      <input id="hydration" placeholder="z. B. 70" />
      <label>Gewicht (g)</label>
      <input id="gewicht" placeholder="z. B. 800" />
      <button id="startBtn">Backvorgang starten</button>
    </div>

    <div id="sim" style="display:none;">
      <div style="text-align:center;font-size:1.2rem;">
        ‚è± Zeit: <span id="zeit">0</span> s
        <div>‚è≥ Restzeit: <span id="restzeit">‚Äì</span></div>
      </div>
      <div style="text-align:center;font-size:2rem;font-weight:600;margin-top:0.5rem;">
        üå° <span id="temp">25.0</span> ¬∞C
      </div>
      <div class="tip" id="tip">Teig ruht ‚Ä¶</div>
      <canvas id="chart"></canvas>
      <button id="stopBtn">Beenden & CSV speichern</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const simDiv = document.getElementById("sim");
    const formDiv = document.getElementById("form");
    const tempEl = document.getElementById("temp");
    const timeEl = document.getElementById("zeit");
    const restEl = document.getElementById("restzeit");
    const tipEl = document.getElementById("tip");

    let time = 0, temp = 25, running = false, interval;
    const data = [];

    const ctx = document.getElementById("chart").getContext("2d");
    const chart = new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{
        label: "Temperatur (¬∞C)",
        data: [],
        borderColor: "#000",
        borderWidth: 2,
        tension: 0.3,
        pointRadius: 0
      }]},
      options: {
        animation: false,
        scales: {
          y: { min: 20, max: 120 },
          x: { title: { display: true, text: "Zeit (s)" } }
        }
      }
    });

    startBtn.onclick = () => {
      running = true;
      formDiv.style.display = "none";
      simDiv.style.display = "block";
      time = 0; temp = 25;
      data.length = 0;
      interval = setInterval(simulate, 1000);
    };

    stopBtn.onclick = () => {
      running = false;
      clearInterval(interval);
      exportCSV();
      formDiv.style.display = "block";
      simDiv.style.display = "none";
    };

    function simulate() {
      time++;
      if (temp < 230) temp += 0.8;
      else if (temp < 245) temp += 0.2;
      tempEl.textContent = temp.toFixed(1);
      timeEl.textContent = time;

      const rate = time > 10 ? (temp - 25) / (time / 60) : 0;
      const remaining = rate > 0 ? Math.max(0, (95 - temp) / (rate / 60)).toFixed(1) : "‚Äì";
      restEl.textContent = remaining;

      if (temp < 60) tipEl.textContent = "Teig erw√§rmt sich ‚Äì G√§rreste verdampfen ‚Ä¶";
      else if (temp < 95) tipEl.textContent = "Brot backt ‚Äì Kruste bildet sich ‚Ä¶";
      else if (temp < 100) tipEl.textContent = "Kerntemperatur erreicht ‚Äì Brot ist fertig !";
      else tipEl.textContent = "Backvorgang abgeschlossen.";

      data.push({ t: time, temp });
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(temp);
      chart.update();
    }

    function exportCSV() {
      const r = {
        name: document.getElementById("rname").value,
        mehl: document.getElementById("mehl").value,
        hydration: document.getElementById("hydration").value,
        gewicht: document.getElementById("gewicht").value,
      };
      let csv = "Zeit (s),Temperatur (¬∞C),Rezept,Mehl,Hydration,Gewicht\n";
      data.forEach(d => {
        csv += `${d.t},${d.temp.toFixed(2)},${r.name},${r.mehl},${r.hydration},${r.gewicht}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${r.name || "brot"}-daten.csv`;
      a.click();
    }

    // --- PWA Service Worker registrieren ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
