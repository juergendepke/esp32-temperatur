<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SensorDashboard BLE</title>
    <meta name="theme-color" content="#007aff">
    <meta name="description" content="BLE Sensor Monitoring Dashboard für ESP32">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SensorDashboard">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📊</text></svg>">
    <link rel="stylesheet" href="styles.css">
    
    <style>
    /* PWA-spezifische Styles */
    @media all and (display-mode: standalone) {
        .topbar {
            padding-top: env(safe-area-inset-top);
        }
    }
    
    /* Scan Progress */
    .scan-progress {
        text-align: center;
        padding: 20px;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--text-tertiary);
        border-radius: 4px;
        overflow: hidden;
        margin: 16px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--accent-light));
        border-radius: 4px;
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .scanning-animation {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes scanPulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .scanning .btn.primary {
        animation: scanPulse 1.5s infinite;
    }
    </style>
</head>
<body>
    <header class="topbar">
        <h1>📊 SensorDashboard</h1>
        <div class="topbar-actions">
            <button id="scanBtn" class="btn primary">🔍 Auto Scan</button>
            <button id="disconnectAllBtn" class="btn secondary">❌ Alle trennen</button>
        </div>
    </header>

    <main>
        <!-- Geräteliste -->
        <section class="card">
            <div class="card-header">
                <h3>📱 Verfügbare Geräte</h3>
                <span id="deviceCount" class="badge">0 verbunden</span>
            </div>
            <div id="availableDevices" class="devices-list">
                <div class="no-devices">
                    <p>🔍 Keine Geräte gefunden</p>
                    <p class="hint">Klicke auf "Auto Scan" um automatisch nach Sensoren zu suchen</p>
                </div>
            </div>
        </section>

        <!-- Sensor Dashboard -->
        <section class="card">
            <div class="card-header">
                <h3>📊 Sensor Dashboard</h3>
                <span id="sensorCount" class="badge">0 Sensoren</span>
            </div>
            <div id="sensorDashboard" class="dashboard-grid">
                <div class="no-sensors">
                    <p>🌡️⚡ Keine Sensoren verbunden</p>
                    <p class="hint">Verbinde Geräte um deren Daten hier zu sehen</p>
                </div>
            </div>
        </section>

        <!-- Einstellungen -->
        <section class="card">
            <div class="card-header">
                <h3>⚙️ Einstellungen</h3>
            </div>
            
            <div class="setting-group">
                <label class="setting-label">
                    Update-Intervall: <span id="intervalValue" style="color: var(--accent); font-weight: 700;">2</span>s
                </label>
                <input type="range" id="intervalSlider" min="1" max="60" value="2" class="slider">
                <button id="applyInterval" class="btn secondary" style="width: 100%; margin-top: 8px;">
                    💾 Für alle Geräte übernehmen
                </button>
            </div>

            <div class="setting-group">
                <label class="setting-label">
                    Auto-Scan Dauer: <span id="scanDurationValue" style="color: var(--accent); font-weight: 700;">15</span>s
                </label>
                <input type="range" id="scanDurationSlider" min="5" max="30" value="15" class="slider">
                <small style="color: var(--text-secondary); display: block; margin-top: 8px;">
                    ⏱️ Dauer des automatischen Scans
                </small>
            </div>
        </section>

        <!-- Status Information -->
        <section class="card">
            <div class="row">
                <strong>🔗 BLE Status</strong>
                <span id="bleStatus" class="status-available">Verfügbar</span>
            </div>
            <div class="row">
                <strong>📱 Verbundene Geräte</strong>
                <span id="connectedDevicesCount">0</span>
            </div>
            <div class="row">
                <strong>🕒 Letzter Scan</strong>
                <span id="lastScanTime">—</span>
            </div>
            <div class="row">
                <strong>📡 Scan Modus</strong>
                <span id="scanMode">Auto-Scan</span>
            </div>
        </section>
    </main>

    <!-- Scan Progress Overlay -->
    <div id="scanProgress" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="scan-progress">
            <p id="scanProgressText">🔍 Scanne nach Sensoren...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="scanProgressBar"></div>
            </div>
            <p id="foundDevicesCount">Gefundene Geräte: <strong>0</strong></p>
            <button id="stopScanBtn" class="btn error" style="margin-top: 16px;">⏹️ Scan stoppen</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <p id="loadingText">Verbinde mit Gerät...</p>
    </div>

    <!-- Device Selection Modal -->
    <div id="deviceModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🔍 Gerät auswählen</h3>
                <button id="closeModal" class="btn-close">×</button>
            </div>
            <div id="deviceList" class="modal-body">
                <!-- Wird dynamisch gefüllt -->
            </div>
            <div class="modal-footer" style="padding: 16px; border-top: 0.5px solid var(--text-tertiary); text-align: center;">
                <button id="rescanBtn" class="btn secondary">🔄 Erneut scannen</button>
            </div>
        </div>
    </div>

    <script src="deviceManager.js"></script>
    <script src="app.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
    // Service Worker registrieren
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registriert: ', registration.scope);
                })
                .catch(function(error) {
                    console.log('ServiceWorker Registrierung fehlgeschlagen: ', error);
                });
        });
    }

    // App Mode Detection
    function detectAppMode() {
        const scanModeElement = document.getElementById('scanMode');
        
        if (window.matchMedia('(display-mode: standalone)').matches) {
            scanModeElement.textContent = 'PWA + Auto-Scan';
        } else {
            scanModeElement.textContent = 'Browser + Auto-Scan';
        }
    }

    window.addEventListener('load', detectAppMode);
    </script>
</body>
</html>
